<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title }} - Passage</title>
  <style>
    :root {
      --bg: #a9bee6;
      --panel: #ffffffb9;            /* match exam.html */
      --text: #111827;              /* match exam.html */
      --muted: #6b7280c0;            /* match exam.html */
      --line: #035c2f;               /* match exam.html */
      --primary: #080330;            /* match exam.html */
      --primaryHover: #4ea9e6;       /* match exam.html */
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.65;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 92px 18px 28px;
    }

    /* Header style aligned to exam.html */
    .header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--panel);
      border-bottom: 1px solid var(--line);
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      max-width: 980px;
      margin: 0 auto;
    }

    .h-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .h-title {
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60vw;
    }

    .h-sub {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: transparent;
    }

    .rightBox {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    /* Timer UI aligned to exam.html */
    .timerBox { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .timeLabel { font-size: 12px; color: var(--muted); }

    .timeValue {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 6px;
      padding: 6px 10px;
      font-weight: 800;
      min-width: 92px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .progress {
      width: 160px;
      height: 8px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid var(--line);
      overflow: hidden;
    }
    .progress > div { height: 100%; width: 0%; background: var(--primary); }

    .btn {
      background: var(--primary);
      color: #fff;
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      user-select: none;
    }
    .btn:hover { background: var(--primaryHover); border-color: var(--primaryHover); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 18px 18px;
    }

    .content-title {
      margin: 0 0 10px 0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .content {
      background: rgba(255,255,255,0.7);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 16px 16px;
      font-size: 15px;
      white-space: pre-wrap;
    }

    .footer-hint {
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 700px) {
      .progress { display: none; }
      .wrap { padding-top: 84px; }
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-inner">
      <div class="h-left">
        <div class="h-title">{{ passage_title }}</div>
        <div class="h-sub">
          <span>Reading</span>
          <span class="badge">Passage</span>
          <span class="badge">Read first, then Next</span>
        </div>
      </div>

      <div class="rightBox">
        <div class="timerBox">
          <div class="timeLabel">Time Left</div>
          <div class="timeValue" id="timeLeft">--:--</div>
          <div class="progress" aria-hidden="true"><div id="timeBar"></div></div>
        </div>
        <button class="btn" id="nextBtn" type="button">Next</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <h1 class="content-title">{{ passage_title }}</h1>
      <div class="content">{{ passage_text }}</div>
      <div class="footer-hint">Tip: You can scroll freely. The timer continues running.</div>
    </div>
  </div>

  <script>
    // Make timer behavior identical to exam.html:
    // - started_at is epoch seconds (int) in your routes.py
    // - duration_seconds is int
    // - when time is up, send user to /exam/<attempt_id>/autosubmit (so backend handles timeout correctly)

    const attemptId = "{{ attempt_id }}";
    const duration = Number({{ duration_seconds | default(0) }}) || 0;
    const startedAtSecRaw = {{ started_at | default(0) }};
    const startedAtSec = Number(startedAtSecRaw);
    const startedAt = (Number.isFinite(startedAtSec) && startedAtSec > 0) ? (startedAtSec * 1000) : Date.now();

    const nextUrl = "{{ next_url }}";

    let tickHandle = null;
    let stopped = false;

    function stopTimerUI() {
      stopped = true;
      if (tickHandle) {
        clearTimeout(tickHandle);
        tickHandle = null;
      }
    }

    function fmt(s) {
      const m = Math.floor(s / 60);
      const r = s % 60;
      return String(m).padStart(2,'0') + ":" + String(r).padStart(2,'0');
    }

    function tick() {
      if (stopped) return;

      const elapsed = Math.floor((Date.now() - startedAt) / 1000);
      const left = Math.max(0, duration - elapsed);

      const timeEl = document.getElementById("timeLeft");
      if (timeEl) timeEl.textContent = fmt(left);

      const bar = document.getElementById("timeBar");
      if (bar) {
        const pct = duration > 0 ? Math.min(100, Math.max(0, (elapsed / duration) * 100)) : 0;
        bar.style.width = pct.toFixed(2) + "%";
      }

      if (left <= 0) {
        stopTimerUI();
        // Use backend autosubmit route to mark timed_out properly.
        // We have no answers on passage page, so just POST empty form.
        const f = document.createElement("form");
        f.method = "POST";
        f.action = `/exam/${attemptId}/autosubmit`;
        document.body.appendChild(f);
        f.submit();
        return;
      }

      tickHandle = setTimeout(tick, 500);
    }

    function goNext() {
      window.location.href = nextUrl;
    }

    document.getElementById("nextBtn").addEventListener("click", goNext);

    tick();
  </script>
</body>
</html>
